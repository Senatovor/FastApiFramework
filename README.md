# –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –≤ FastAPI

## üìå –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîê JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (access –∏ refresh —Ç–æ–∫–µ–Ω—ã –≤ cookies)
- üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
- üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ refresh token
- üè¶ –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –≤ Redis
- üõ°Ô∏è Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
- üóÉÔ∏è CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ SQLAlchemy
- üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–∞ —Ç–∞–∫–∂–µ —É–¥–æ–±–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ loguru)
- üîé –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API
- üîÑ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- üê≥ Docker
- üëÄ –ü–∞—Ä–∞ –ø—Ä–æ–±–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```text
src/  
‚îú‚îÄ‚îÄ auth/  
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py       # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏  
‚îÇ   ‚îú‚îÄ‚îÄ exceptions.py         # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏  
‚îÇ   ‚îú‚îÄ‚îÄ handler.py            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏  
‚îÇ   ‚îú‚îÄ‚îÄ managers.py           # –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py         # Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤  
‚îÇ   ‚îú‚îÄ‚îÄ models.py             # –ú–æ–¥–µ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
‚îÇ   ‚îú‚îÄ‚îÄ router.py             # –†–æ—É—Ç–µ—Ä –¥–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏  
‚îÇ   ‚îú‚îÄ‚îÄ schemes.py            # Pydantic —Å—Ö–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏  
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏  
‚îÇ   ‚îî‚îÄ‚îÄ services.py           # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏  
‚îú‚îÄ‚îÄ database/  
‚îÇ   ‚îú‚îÄ‚îÄ manager.py            # –ë–∞–∑–æ–≤—ã–π CRUD –º–µ–Ω–µ–¥–∂–µ—Ä  
‚îÇ   ‚îú‚îÄ‚îÄ model.py              # –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å SQLAlchemy  
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–¥  
‚îÇ   ‚îî‚îÄ‚îÄ session.py            # –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Å—Å–∏–π –ë–î  
‚îú‚îÄ‚îÄ redis_database/  
‚îÇ   ‚îú‚îÄ‚îÄ client.py             # –ö–ª–∏–µ–Ω—Ç Redis  
‚îÇ   ‚îî‚îÄ‚îÄ config.py             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis  
‚îú‚îÄ‚îÄ exceptions.py             # –ö–∞—Å—Ç–æ–º–Ω—ã–µ –æ–±—â–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è  
‚îú‚îÄ‚îÄ log.py                    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ  
‚îú‚îÄ‚îÄ schemes.py                # –û–±—â–∏–µ Pydantic —Å—Ö–µ–º—ã  
‚îú‚îÄ‚îÄ main.py                   # –í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞  
‚îú‚îÄ‚îÄ utils.py                  # –û–±—â–∏–µ —É—Ç–∏–ª–∏—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–º–æ—â–Ω–∏–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API)  
‚îî‚îÄ‚îÄ config.py                 # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥  
```
## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- FastAPI - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- SQLAlchemy - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- asyncpg - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥—Ä–∞–π–≤–µ—Ä PostgreSQL
- Redis - —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π
- JWT - —Ç–æ–∫–µ–Ω—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- Pydantic - –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- Loguru - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- Alembic - –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- Celery - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ .env —Ñ–∞–π–ª–µ
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–æ–∫–µ—Ä: **docker-compose up -d**


## üß† –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:
   - –ü–∞—Ä–æ–ª—å —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é bcrypt
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å username –∏ email

2. –í—Ö–æ–¥:
   - –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
   - –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è JWT —Ç–æ–∫–µ–Ω—ã
   - –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ Redis

3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤:
   - Access token –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ (–µ—Å–ª–∏ –æ–Ω –Ω–µ –≤ —Å–ø–∏—Å–∫–µ public routes –≤ auth/config)
   - –ü—Ä–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–µ access token –ø–µ—Ä–µ–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ refresh, –ø–æ—Å–ª–µ —á–µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ
   - –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω, –Ω–µ –¥–∞–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –≤ login –∏ register

4. –í—ã—Ö–æ–¥:
   - –£–¥–∞–ª—è–µ—Ç—Å—è —Å–µ—Å—Å–∏—è –∏–∑ Redis
   - –û—á–∏—â–∞—é—Ç—Å—è cookies —Å —Ç–æ–∫–µ–Ω–∞–º–∏

## üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: –í–°–¢–ê–í–ò–¢–¨ –°–°–´–õ–ö–£

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞—â–∏—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞
```python
from fastapi import APIRouter, Depends
from typing import Annotated

from ..auth.dependencies import get_current_user
from ..auth.schemes import UserData

users_router = APIRouter(
    prefix='/users',
    tags=['users'],
)

@users_router.get(
    '/info',
    name='users-info',
    response_model=UserData,
    summary="–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞",
)
async def user_info(user: Annotated[UserData, Depends(get_current_user)]):
    return user
```
### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–π Redis –∏ SQL –±–∞–∑—ã –¥–ª—è FastAPI
```python
async def login(
        login_user: LoginUser,
        session: DbSessionDepends(),
        redis_client: RedisDepends(),
        service: Annotated[UserService, Depends(UserService)],
):
```
### –†–∞–±–æ—Ç–∞ CRUD:
```python
from src.database.manager import BaseManager

class UserManager(BaseManager):
    """–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    model = User


class UserService:

    def __init__(
            self,
            manager: Annotated[UserManager, Depends(UserManager)],
    ) -> None:
        self.manager = manager

    async def login(
            self,
            db_session: AsyncSession,
            login_user: LoginUser,
            redis_client: Redis
    ):
        user = await self.manager.find_one_by(
            db_session,
            UsernameUser(username=login_user.username)  # Pydantic –º–æ–¥–µ–ª—å
        )
        await redis_client.set(
            f"session:{str(user.id)}",
            str(user.id),
        )
```
–î–ª—è –±–æ–ª—å—à–µ–≥–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —ç—Ç–æ—Ç [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –º–æ–µ–≥–æ SQL-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞](https://github.com/Senatovor/BigSQLAss.ync)

### –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
```python
@auth_router.post(
    '/register',
    responses={
        **ok_response_docs(
            status_code=status.HTTP_201_CREATED,
            description='–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω'
        ),
        **error_response_docs(
            error=HttpAlreadyExistException     # –≠–¢–û HTTP –û–®–ò–ë–ö–ê (—Å–º. –Ω–∏–∂–µ)
        ),
        **error_response_docs(
            error=HttpServerException
        )
    }
)
```


## üìà –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Alembic –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏—è–º–∏:

1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
alembic init migrations
2. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
alembic revision --autogenerate -m "init"
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π:
alembic upgrade head


## üì¶ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
–í—Å–µ –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:
```python
HttpNotAuthException = HTTPException(
    status_code=status.HTTP_401_UNAUTHORIZED,
    detail='–í—ã –Ω–µ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É',
    headers={'WWW-Authenticate': 'Bearer'},
)
```
### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é Loguru:
```python
logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {register_user.username} —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è...")
```
### Redis —Å–µ—Å—Å–∏–∏
–°–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis —Å –∫–ª—é—á–∞–º–∏ –≤–∏–¥–∞ session:{user_id}:
```python
await redis_client.set(f"session:{str(user.id)}", str(user.id))
```

### –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
–í—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ø–æ–¥ —Å–≤–æ–π –ª–∞–¥! –ò–∑ –ø—Ä–æ—Å—Ç–æ–≥–æ, –µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —Ç–æ –ø—Ä–æ—Å—Ç–æ —É–±–µ—Ä–∏—Ç–µ —ç—Ç–∏ –¥–≤–µ —Å—Ç—Ä–æ—á–∫–∏ –∫–æ–¥–∞ –≤ —Ñ–∞–π–ª–µ main:  
```python
app.add_middleware(TokenValidationMiddleware)
app.include_router(auth_router)
```
–°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ç–æ—á–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ - main, —Ç–∞–º –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫–∏–µ –º–æ–¥—É–ª–∏ –≤–∞–º –Ω—É–∂–Ω—ã
